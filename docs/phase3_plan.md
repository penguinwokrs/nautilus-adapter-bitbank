# フェーズ 3 計画: 堅牢化とプロダクト品質への向上

## 目的
リアルタイム同期機能（PubNub 統合、トークン自動更新）をプロダクト品質へと昇華させ、Nautilus Trader のエコシステム内で最も安定したアダプターの一つにする。

## 主要タスク

### 1. Nautilus Clock 仕様の完全準拠 (最優先)
- **現状**: タイマー設定時の型不一致でスモークテスト終了処理がハングしていた。
- **対応**: 
    - `nautilus_trader` の `Clock` 実装をソースレベルで再確認。
    - 正しいナノ秒演算（`UnixTime` オブジェクトへの変換が必要か等）を確立。
    - 安定した終了タイマーをスモークテストに再導入する。

### 2. 約定通知のリアルタイム化統合
- **現状**: 約定は現在 REST ポーリング（`get_active_orders`）への依存が残っている。
- **対応**:
    - PubNub の `TradeUpdate` (`spot_trade`) を `execution.py` で受け取り、`PositionUpdate` や `Fill` イベントを直接発行できるようにする。
    - これにより、REST へのリクエスト頻度を劇的に下げ（セーフティネットとしてのみ使用）、API 制限への耐性を高める。

### 3. 長時間負荷テストとエラーリカバリの検証
- **対応**:
    - 24時間以上の連続ライブ接続試験。
    - 意図的なネットワーク切断や API 鍵の無効化に対する、Rust レイヤーでの指数バックオフとエラー通知の挙動を検証。
    - トークン更新時に API 送信エラーが発生した場合の適切なフォールバック処理の追加。

### 4. コードクリーンアップと構成の最終化
- **対応**:
    - `logging.getLogger("nautilus.bitbank.xxx")` の命名規則を Nautilus の標準に合わせる。
    - 冗長な `print` 文の完全排除。
    - `DEBUG` ログの整理（ノイズとならない適切な粒度）。

## マイルストーン
1. **Week 1**: Clock 仕様の解決と `TradeUpdate` の統合。
2. **Week 2**: 負荷テストと長時間接続の安定性確認。
3. **Week 3**: 最終クリーンアップ、ドキュメントの完成、および安定版 (v1.0.0-rc) のリリース。

---
作成日: 2026-02-07
